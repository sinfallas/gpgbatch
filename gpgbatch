#!/usr/bin/env bash
# Made by Jesus Palencia
# Licence: GPL-2
LC_ALL=C
trap "rm -f /run/$(basename $0).pid; exit" 0 1 2 3 15
echo "$BASHPID" > /run/$(basename $0).pid

function pause() {
	read -p "$*"
}

pause "Presione cualquier tecla para iniciar o Ctrl + C para finalizar..."

if [[ -d /tmp/datos.txt ]]; then
	rm -rf /tmp/llaves/*
else
	mkdir -p /tmp/llaves
fi

if [[ -f /tmp/datos.txt ]]; then
	for i in $(cat /tmp/datos.txt); do
		long=$(echo $i | cut -d ":" -f1)
		name=$(echo $i | cut -d ":" -f2)
		last=$(echo $i | cut -d ":" -f3)
		email=$(echo $i | cut -d ":" -f4)
		echo 'Key-Type: 1' > /tmp/genkey
		echo 'Key-Length:' $long >> /tmp/genkey
		echo 'Subkey-Type: 1' >> /tmp/genkey
		echo 'Subkey-Length:' $long >> /tmp/genkey
		echo 'Name-Real:' $name $last >> /tmp/genkey
		echo 'Name-Email:' $email >> /tmp/genkey
		echo 'Expire-Date: 2y' >> /tmp/genkey
		script -q /dev/stdout -c 'gpg --batch --gen-key /tmp/genkey' | tee /tmp/listo
		millave=$(cat /tmp/listo | grep "gpg: clave" | uniq | awk '{print $3}')
		gpg --export-secret-key -a $millave > /tmp/llaves/$name.$last.private.key
		gpg --export -a $millave > /tmp/llaves/$name.$last.public.key
		# gpg --output /tmp/llaves/$name.$last.revoke.asc --gen-revoke 0x$millave
		if [[ $1 = enviar ]]; then
			gpg --send-keys --keyserver keyserver.ubuntu.com $millave
		fi
		rm -f /tmp/genkey
		rm -f /tmp/listo
	done
else
	echo "ERROR: El archivo /tmp/datos.txt no existe"
fi

echo "Finalizado..."

rm -f /run/$(basename $0).pid
exit 0
